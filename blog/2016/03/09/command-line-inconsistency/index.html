<!DOCTYPE html>
<html lang="en">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">


        <title>Command line inconsistency</title>

            <link href="https://mindriot101.github.io/feeds/all.xml" type="application/atom+xml" rel="alternate" title="circularspace Full Atom Feed" />
            <link href="https://mindriot101.github.io/feeds/tech.xml" type="application/atom+xml" rel="alternate" title="circularspace Categories Atom Feed" />
        <!-- Bootstrap Core CSS -->
        <link href="https://mindriot101.github.io/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="https://mindriot101.github.io/theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="https://mindriot101.github.io/theme/css/code_blocks/monokai.css" rel="stylesheet">


        <!-- Custom Fonts -->
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->



        <meta name="description" content="RTFM! Today I brought down our head node at work, because of a misunderstanding of command line arguments for a linux program. In fairness, ...">

        <meta name="author" content="Simon Walker">

        <meta name="tags" content="linux">

	                <meta property="og:locale" content="">
		<meta property="og:site_name" content="circularspace">

	<meta property="og:type" content="article">
            <meta property="article:author" content="https://mindriot101.github.io/author/simon-walker.html">
	<meta property="og:url" content="https://mindriot101.github.io/blog/2016/03/09/command-line-inconsistency/">
	<meta property="og:title" content="Command line inconsistency">
	<meta property="article:published_time" content="2016-03-09 15:20:14+00:00">
            <meta property="og:description" content="RTFM! Today I brought down our head node at work, because of a misunderstanding of command line arguments for a linux program. In fairness, ...">

            <meta property="og:image" content="https://mindriot101.github.io/theme/images/post-bg.jpg">
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:site" content="@srwalker101">
        <meta name="twitter:title" content="Command line inconsistency">

            <meta name="twitter:image" content="https://mindriot101.github.io/theme/images/post-bg.jpg">

            <meta name="twitter:description" content="RTFM! Today I brought down our head node at work, because of a misunderstanding of command line arguments for a linux program. In fairness, ...">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="https://mindriot101.github.io/">circularspace</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                        <li><a href="/archives.html">all</a></li>

                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
        <header class="intro-header" style="background-color: #444">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Command line inconsistency</h1>
                        <span class="meta">Posted by
                                <a href="https://mindriot101.github.io/author/simon-walker.html">Simon Walker</a>
                             on Wed 09 March 2016
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    <!-- Post Content -->
    <article>
        <h2>RTFM!</h2>
<p>Today I brought down our head node at work, because of a
misunderstanding of command line arguments for a linux program.</p>
<p><em>In fairness, I should have read the man page more carefully for the
entry in question!</em></p>
<p>I was using xargs for some nice command line parallelism and process
running. The command I ran was:</p>
<div class="highlight"><pre>ls <span class="p">|</span> grep action119 <span class="p">|</span> grep exposureCycle <span class="p">|</span> xargs -n <span class="m">1</span> -I <span class="o">{}</span> find <span class="o">{}</span> -name <span class="s1">&#39;IMAGE*.fits&#39;</span> <span class="p">|</span> xargs -n <span class="m">1</span> -P <span class="m">0</span> bzip2 -k
</pre></div>


<p>In summary this finds the directories containing "action119" and
"exposureCycle" in the current directory, finds all of the files called
<code>IMAGE*.fits</code> in each directory and then in parallel compresses them
while keeping the original file (<code>-k</code>).</p>
<p><code>xargs</code> is used twice in this invocation, and is one of my new favourite
tools. It takes a multi-line input on stdin, and passes each line to
whatever command that follows, e.g.:</p>
<div class="highlight"><pre>ls <span class="p">|</span> xargs <span class="nb">echo</span>
</pre></div>


<p>is the same as</p>
<div class="highlight"><pre>ls <span class="p">|</span> <span class="k">while</span> <span class="nb">read </span>filename<span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="nv">$filename</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># or</span>
<span class="c"># for file in $(ls); do echo $filename; done</span>
</pre></div>


<p>It just dumps the input on the end of the command that follows <code>xargs</code>.
The argument <code>-n</code> says run the following command for each line on the
input, otherwise it dumps them all[1] on the end of the command. <code>-I {}</code>
replaces all occurrences of <code>{}</code> in the command with the input argument.</p>
<p>The first xargs invocation runs <code>find</code> for each directory, which then
prints a long list of files. The second xargs invocation bzips the files
in parallel, whilst keeping the original.</p>
<p>The key error was the <code>-P</code> argument. From the man page:</p>
<div class="highlight"><pre>--max-procs=max-procs
-P max-procs
    Run up to max-procs processes at a time; the default is 1.  If
    max-procs is 0, xargs will run as many processes as possible at a
    time.  Use the -n option with -P; otherwise chances are that only
    one exec will be done.
</pre></div>


<p>In other linux programs I've used (e.g. GNU parallel) specifying <code>0</code> for
the number of processes means run the same as the number of processors
on the machine. For xargs, importantly it says "run as many processes as
possible", pretty much meaning one per input file.</p>
<p>I expected 16 processes to be spawned, one for each (virtual) core. It
spawned ~5k processes one per input file.</p>
<p>It brought the system down for about an hour, but it did seem to recover
ok.</p>
<p>In conclusion: <strong>RTFM!</strong></p>
<p><em>[1] actually because of linux command length restrictions, it splits the
lines up to follow this limitation, and runs the command multiple times
in groups if need be</em></p>
    </article>

        <div class="tags">
            <p>tags: <a href="https://mindriot101.github.io/tag/linux.html">linux</a></p>
        </div>

    <hr>

            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                            <li>
                                <a href="https://twitter.com/srwalker101">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/mindriot101">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                    </ul>
<p class="copyright text-muted">
    Blog powered by <a href="http://getpelican.com">Pelican</a>,
    which takes great advantage of <a href="http://python.org">Python</a>.
</p>                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="https://mindriot101.github.io/theme/js/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="https://mindriot101.github.io/theme/js/bootstrap.min.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="https://mindriot101.github.io/theme/js/clean-blog.min.js"></script>

</body>

</html>