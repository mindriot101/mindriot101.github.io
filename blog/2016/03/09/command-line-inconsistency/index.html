<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Command line inconsistency - circularspace</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://blog.simonrw.com/blog/2016/03/09/command-line-inconsistency/">

        <meta name="author" content="Simon Walker" />
        <meta name="keywords" content="linux" />
        <meta name="description" content="RTFM! Today I brought down our head node at work, because of a misunderstanding of command line arguments for a linux program. In fairness, I should have read the man page more carefully for the entry in question! I was using xargs for some nice command line parallelism and process ..." />

        <meta property="og:site_name" content="circularspace" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Command line inconsistency"/>
        <meta property="og:url" content="https://blog.simonrw.com/blog/2016/03/09/command-line-inconsistency/"/>
        <meta property="og:description" content="RTFM! Today I brought down our head node at work, because of a misunderstanding of command line arguments for a linux program. In fairness, I should have read the man page more carefully for the entry in question! I was using xargs for some nice command line parallelism and process ..."/>
        <meta property="article:published_time" content="2016-03-09" />
            <meta property="article:section" content="tech" />
            <meta property="article:tag" content="linux" />
            <meta property="article:author" content="Simon Walker" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://blog.simonrw.com/theme/css/bootstrap.readable.min.css" type="text/css"/>
    <link href="https://blog.simonrw.com/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://blog.simonrw.com/theme/css/pygments/monokai.css" rel="stylesheet">
    <link rel="stylesheet" href="https://blog.simonrw.com/theme/css/style.css" type="text/css"/>

        <link href="https://blog.simonrw.com/feeds/all.xml" type="application/atom+xml" rel="alternate"
              title="circularspace ATOM Feed"/>



        <link href="https://blog.simonrw.com/feeds/tech.xml" type="application/atom+xml" rel="alternate"
              title="circularspace tech ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://blog.simonrw.com/" class="navbar-brand">
circularspace            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="/archives.html">all</a></li>
                        <li >
                            <a href="https://blog.simonrw.com/category/gaming.html">Gaming</a>
                        </li>
                        <li >
                            <a href="https://blog.simonrw.com/category/life.html">Life</a>
                        </li>
                        <li >
                            <a href="https://blog.simonrw.com/category/science.html">Science</a>
                        </li>
                        <li class="active">
                            <a href="https://blog.simonrw.com/category/tech.html">Tech</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="https://blog.simonrw.com/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://blog.simonrw.com/blog/2016/03/09/command-line-inconsistency/"
                       rel="bookmark"
                       title="Permalink to Command line inconsistency">
                        Command line inconsistency
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2016-03-09T15:20:14+00:00"> Wed 09 March 2016</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="https://blog.simonrw.com/tag/linux.html">linux</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <h2>RTFM!</h2>
<p>Today I brought down our head node at work, because of a
misunderstanding of command line arguments for a linux program.</p>
<p><em>In fairness, I should have read the man page more carefully for the
entry in question!</em></p>
<p>I was using xargs for some nice command line parallelism and process
running. The command I ran was:</p>
<div class="highlight"><pre>ls <span class="p">|</span> grep action119 <span class="p">|</span> grep exposureCycle <span class="p">|</span> xargs -n <span class="m">1</span> -I <span class="o">{}</span> find <span class="o">{}</span> -name <span class="s1">&#39;IMAGE*.fits&#39;</span> <span class="p">|</span> xargs -n <span class="m">1</span> -P <span class="m">0</span> bzip2 -k
</pre></div>


<p>In summary this finds the directories containing "action119" and
"exposureCycle" in the current directory, finds all of the files called
<code>IMAGE*.fits</code> in each directory and then in parallel compresses them
while keeping the original file (<code>-k</code>).</p>
<p><code>xargs</code> is used twice in this invocation, and is one of my new favourite
tools. It takes a multi-line input on stdin, and passes each line to
whatever command that follows, e.g.:</p>
<div class="highlight"><pre>ls <span class="p">|</span> xargs <span class="nb">echo</span>
</pre></div>


<p>is the same as</p>
<div class="highlight"><pre>ls <span class="p">|</span> <span class="k">while</span> <span class="nb">read </span>filename<span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="nv">$filename</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># or</span>
<span class="c"># for file in $(ls); do echo $filename; done</span>
</pre></div>


<p>It just dumps the input on the end of the command that follows <code>xargs</code>.
The argument <code>-n</code> says run the following command for each line on the
input, otherwise it dumps them all[1] on the end of the command. <code>-I {}</code>
replaces all occurrences of <code>{}</code> in the command with the input argument.</p>
<p>The first xargs invocation runs <code>find</code> for each directory, which then
prints a long list of files. The second xargs invocation bzips the files
in parallel, whilst keeping the original.</p>
<p>The key error was the <code>-P</code> argument. From the man page:</p>
<div class="highlight"><pre>--max-procs=max-procs
-P max-procs
    Run up to max-procs processes at a time; the default is 1.  If
    max-procs is 0, xargs will run as many processes as possible at a
    time.  Use the -n option with -P; otherwise chances are that only
    one exec will be done.
</pre></div>


<p>In other linux programs I've used (e.g. GNU parallel) specifying <code>0</code> for
the number of processes means run the same as the number of processors
on the machine. For xargs, importantly it says "run as many processes as
possible", pretty much meaning one per input file.</p>
<p>I expected 16 processes to be spawned, one for each (virtual) core. It
spawned ~5k processes one per input file.</p>
<p>It brought the system down for about an hour, but it did seem to recover
ok.</p>
<p>In conclusion: <strong>RTFM!</strong></p>
<p><em>[1] actually because of linux command length restrictions, it splits the
lines up to follow this limitation, and runs the command multiple times
in groups if need be</em></p>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://twitter.com/srwalker101"><i class="fa fa-twitter-square fa-lg"></i> twitter</a></li>
                <li class="list-group-item"><a href="https://github.com/mindriot101"><i class="fa fa-github-square fa-lg"></i> github</a></li>
              </ul>
            </li>





    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://mindriot101.github.io/cv/" target="_blank">
                CV
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://www2.warwick.ac.uk/fac/sci/physics/research/astro/people/walker/" target="_blank">
                Work
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container-fluid">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2016 Simon Walker
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://blog.simonrw.com/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://blog.simonrw.com/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://blog.simonrw.com/theme/js/respond.min.js"></script>


</body>
</html>