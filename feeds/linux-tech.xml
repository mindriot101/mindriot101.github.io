<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>circularspace</title><link href="https://mindriot101.github.io/" rel="alternate"></link><link href="https://mindriot101.github.io/feeds/linux-tech.xml" rel="self"></link><id>https://mindriot101.github.io/</id><updated>2016-03-09T15:20:14+00:00</updated><entry><title>Command line inconsistency</title><link href="https://mindriot101.github.io/blog/2016/03/09/command-line-inconsistency/" rel="alternate"></link><updated>2016-03-09T15:20:14+00:00</updated><author><name>Simon Walker</name></author><id>tag:mindriot101.github.io,2016-03-09:blog/2016/03/09/command-line-inconsistency/</id><summary type="html">&lt;h2&gt;RTFM!&lt;/h2&gt;
&lt;p&gt;Today I brought down our head node at work, because of a
misunderstanding of command line arguments for a linux program.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;In fairness, I should have read the man page more carefully for the
entry in question!&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;I was using xargs for some nice command line parallelism and process
running. The command I ran was:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;ls &lt;span class="p"&gt;|&lt;/span&gt; grep action119 &lt;span class="p"&gt;|&lt;/span&gt; grep exposureCycle &lt;span class="p"&gt;|&lt;/span&gt; xargs -n &lt;span class="m"&gt;1&lt;/span&gt; -I &lt;span class="o"&gt;{}&lt;/span&gt; find &lt;span class="o"&gt;{}&lt;/span&gt; -name &lt;span class="s1"&gt;&amp;#39;IMAGE*.fits&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; xargs -n &lt;span class="m"&gt;1&lt;/span&gt; -P &lt;span class="m"&gt;0&lt;/span&gt; bzip2 -k
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;In summary this finds the directories containing "action119" and
"exposureCycle" in the current directory, finds all of the files called
&lt;code&gt;IMAGE*.fits&lt;/code&gt; in each directory and then in parallel compresses them
while keeping the original file (&lt;code&gt;-k&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;&lt;code&gt;xargs&lt;/code&gt; is used twice in this invocation, and is one of my new favourite
tools. It takes a multi-line input on stdin, and passes each line to
whatever command that follows, e.g.:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;ls &lt;span class="p"&gt;|&lt;/span&gt; xargs &lt;span class="nb"&gt;echo&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;is the same as&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;ls &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="nb"&gt;read &lt;/span&gt;filename&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="nv"&gt;$filename&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="k"&gt;done&lt;/span&gt;
&lt;span class="c"&gt;# or&lt;/span&gt;
&lt;span class="c"&gt;# for file in $(ls); do echo $filename; done&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;It just dumps the input on the end of the command that follows &lt;code&gt;xargs&lt;/code&gt;.
The argument &lt;code&gt;-n&lt;/code&gt; says run the following command for each line on the
input, otherwise it dumps them all[1] on the end of the command. &lt;code&gt;-I {}&lt;/code&gt;
replaces all occurrences of &lt;code&gt;{}&lt;/code&gt; in the command with the input argument.&lt;/p&gt;
&lt;p&gt;The first xargs invocation runs &lt;code&gt;find&lt;/code&gt; for each directory, which then
prints a long list of files. The second xargs invocation bzips the files
in parallel, whilst keeping the original.&lt;/p&gt;
&lt;p&gt;The key error was the &lt;code&gt;-P&lt;/code&gt; argument. From the man page:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;--max-procs=max-procs
-P max-procs
    Run up to max-procs processes at a time; the default is 1.  If
    max-procs is 0, xargs will run as many processes as possible at a
    time.  Use the -n option with -P; otherwise chances are that only
    one exec will be done.
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;In other linux programs I've used (e.g. GNU parallel) specifying &lt;code&gt;0&lt;/code&gt; for
the number of processes means run the same as the number of processors
on the machine. For xargs, importantly it says "run as many processes as
possible", pretty much meaning one per input file.&lt;/p&gt;
&lt;p&gt;I expected 16 processes to be spawned, one for each (virtual) core. It
spawned ~5k processes one per input file.&lt;/p&gt;
&lt;p&gt;It brought the system down for about an hour, but it did seem to recover
ok.&lt;/p&gt;
&lt;p&gt;In conclusion: &lt;strong&gt;RTFM!&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;[1] actually because of linux command length restrictions, it splits the
lines up to follow this limitation, and runs the command multiple times
in groups if need be&lt;/em&gt;&lt;/p&gt;</summary></entry></feed>